#!/bin/bash
# Add any known themes to the possible_theme_paths array
possible_theme_paths+=("/boot/grub/themes/starfield")
possible_theme_paths+=("/usr/share/grub/themes/breeze/theme.txt") 
possible_theme_paths+=("/usr/share/grub/themes/Vimix/theme.txt")
THIS_LOGDIR=/tmp
THIS_NAME=randomupdater
# Derived
THIS_LOG=$THIS_LOGDIR/$THIS_NAME.log
THIS_ERR=$THIS_LOGDIR/$THIS_NAME.err

NOW=$(date +'%s')
date -I >> $THIS_LOG

main () {
  # add any directory in /boot/grub/themes that contains a theme.txt
  for i in $(find /boot/grub/themes -name theme.txt)
  do
    possible_theme_paths+=("$i")
  done
  
  # process possible themes
  for value in "${possible_theme_paths[@]}"
  do
    if [[ -f "$value" ]]; then
      theme_paths+=("$value")
    fi
  done
  
  print_all () {
    for value in "${theme_paths[@]}"
    do
      echo $value
    done
  }
  # print_all
  
  export GRUB_THEME=${theme_paths[ $RANDOM % ${#theme_paths[@]} ]}
  echo $GRUB_THEME >> $THIS_LOG
  # echo $GRUB_THEME
  
  if [[ -f grub.template ]]; then
    echo '# DO NOT EDIT THIS FILE! IT IS GENERATED AUTOMATICALLY EVERY BOOT' > /etc/default/grub
    envsubst < grub.template >> /etc/default/grub 2>>$THIS_ERR
    grub-mkconfig -o /boot/grub/grub.cfg >> $THIS_LOG 2>>$THIS_ERR
  else
    echo 'a grub.template file must be present!' >> $THIS_LOG
    exit 1
  fi

  THEN=$(date +'%s')
  echo -n "This took $(($THEN - $NOW)) seconds " >>$THIS_LOG
  echo '<<< END of random updater >>>' >>$THIS_LOG
}

main
